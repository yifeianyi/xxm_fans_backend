{% extends "admin/base_site.html" %}
{% load i18n admin_urls static admin_modify %}

{% block extrahead %}{{ block.super }}
{{ form.media }}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function() {
    var $availableSongs = $('#id_available_songs');
    var $selectedSongs = $('#id_selected_songs');
    
    // 更新计数
    function updateCounts() {
        var availableCount = $availableSongs.find('option:visible').length;
        var selectedCount = $selectedSongs.find('option').length;
        
        $('#available_count').text(availableCount);
        $('#selected_count').text(selectedCount);
    }
    
    // 添加选中的歌曲
    function addSelectedSongs() {
        var $selectedOptions = $availableSongs.find('option:selected');
        
        $selectedOptions.each(function() {
            var $option = $(this);
            // 检查是否已存在
            if ($selectedSongs.find('option[value="' + $option.val() + '"]').length === 0) {
                $selectedSongs.append($option.clone());
            }
        });
        
        updateCounts();
    }
    
    // 移除选中的歌曲
    function removeSelectedSongs() {
        $selectedSongs.find('option:selected').remove();
        updateCounts();
    }
    
    // 添加所有歌曲
    function addAllSongs() {
        $availableSongs.find('option').each(function() {
            var $option = $(this);
            if ($selectedSongs.find('option[value="' + $option.val() + '"]').length === 0) {
                $selectedSongs.append($option.clone());
            }
        });
        updateCounts();
    }
    
    // 清空已选歌曲
    function clearAllSongs() {
        $selectedSongs.empty();
        updateCounts();
    }
    
    // 搜索功能（本地搜索）- 优化性能
    function performSearch() {
        var searchTerm = $('#song_search').val().toLowerCase().trim();
        var $options = $availableSongs.find('option');
        
        if (searchTerm === '') {
            // 显示所有歌曲
            $options.show();
        } else {
            // 批量处理，减少DOM操作
            $options.each(function() {
                var $option = $(this);
                var songName = $option.text().toLowerCase();
                $option.toggle(songName.indexOf(searchTerm) !== -1);
            });
        }
        
        updateCounts();
    }
    
    // 全选待选歌曲
    function selectAllAvailable() {
        $availableSongs.find('option:visible').prop('selected', true);
    }
    
    // 选择搜索结果
    function selectFiltered() {
        $availableSongs.find('option:visible').prop('selected', true);
    }
    
    // 移除搜索结果
    function removeFiltered() {
        var searchTerm = $('#song_search').val().toLowerCase().trim();
        if (searchTerm) {
            $selectedSongs.find('option').each(function() {
                var $option = $(this);
                if ($option.text().toLowerCase().indexOf(searchTerm) !== -1) {
                    $option.remove();
                }
            });
            updateCounts();
        }
    }
    
    // 绑定事件
    $('#add_selected').click(addSelectedSongs);
    $('#remove_selected').click(removeSelectedSongs);
    $('#add_all').click(addAllSongs);
    $('#remove_all').click(clearAllSongs);
    $('#clear_all').click(clearAllSongs);
    $('#select_all').click(selectAllAvailable);
    $('#select_filtered').click(selectFiltered);
    $('#remove_filtered').click(removeFiltered);
    
    // 双击添加/移除
    $availableSongs.dblclick(addSelectedSongs);
    $selectedSongs.dblclick(removeSelectedSongs);
    
    // 搜索功能
    $('#song_search').on('input', performSearch);
    
    // 初始化计数
    updateCounts();
    
    // 表单提交前，确保已选歌曲被选中
    $('#batch_add_form').submit(function() {
        $selectedSongs.find('option').prop('selected', true);
        // 同时确保available_songs中的选项不被提交
        $availableSongs.find('option').prop('selected', false);
    });
});
</script>
<style>
.song-selector-container {
    display: flex;
    gap: 20px;
    margin-bottom: 20px;
}

.song-selector-box {
    flex: 1;
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 15px;
    background: #f9f9f9;
}

.song-selector-box h3 {
    margin-top: 0;
    margin-bottom: 10px;
    color: #333;
    font-size: 14px;
}

.song-selector-box select {
    width: 100%;
    height: 300px;
    border: 1px solid #ccc;
    border-radius: 3px;
    padding: 5px;
}

.search-input {
    width: 100%;
    padding: 8px;
    margin-bottom: 10px;
    border: 1px solid #ccc;
    border-radius: 3px;
    box-sizing: border-box;
}

.button-group {
    display: flex;
    gap: 10px;
    margin-top: 10px;
}

.button-group button {
    padding: 6px 12px;
    border: 1px solid #ccc;
    border-radius: 3px;
    background: #fff;
    cursor: pointer;
    font-size: 12px;
}

.button-group button:hover {
    background: #f0f0f0;
}

.tag-selector {
    margin-top: 20px;
    padding: 15px;
    background: #f9f9f9;
    border: 1px solid #ddd;
    border-radius: 4px;
}

.tag-selector label {
    display: inline-block;
    margin-right: 10px;
    font-weight: bold;
}

.submit-row {
    margin-top: 20px;
    padding: 10px 0;
    border-top: 1px solid #ddd;
}

.selected-count {
    font-size: 12px;
    color: #666;
    margin-top: 5px;
}

.search-info {
    font-size: 12px;
    color: #666;
    margin-bottom: 5px;
}
</style>
{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
<a href="{% url 'admin:index' %}">{% translate 'Home' %}</a>
&rsaquo; <a href="{% url 'admin:app_list' app_label=opts.app_label %}">{{ opts.app_config.verbose_name }}</a>
&rsaquo; <a href="{% url opts|admin_urlname:'changelist' %}">{{ opts.verbose_name_plural|capfirst }}</a>
&rsaquo; {{ title }}
</div>
{% endblock %}

{% block content %}
<div id="content-main">
    <form method="post" id="batch_add_form">
        {% csrf_token %}
        <div class="module">
            <h2>批量添加歌曲标签</h2>
            <p>选择歌曲和标签，系统会为选中的歌曲添加指定的标签。</p>
            
            <!-- 歌曲选择区域 -->
            <div class="song-selector-container">
                <!-- 左侧：待选歌曲 -->
                <div class="song-selector-box">
                    <h3>待选歌曲</h3>
                    <input type="text" id="song_search" class="search-input" placeholder="输入歌曲名称搜索..." value="{{ form.song_search.value|default:'' }}">
                    <div class="search-info" id="search_info"></div>
                    {{ form.available_songs }}
                    <div class="selected-count" id="available_count">共 {{ form.available_songs.field.queryset.count }} 首歌曲</div>
                    <div class="button-group">
                        <button type="button" id="select_all">全选</button>
                        <button type="button" id="select_filtered">选择搜索结果</button>
                    </div>
                </div>
                
                <!-- 中间：操作按钮 -->
                <div style="display: flex; flex-direction: column; justify-content: center; gap: 10px;">
                    <button type="button" id="add_selected" class="button" style="padding: 8px 16px;">→</button>
                    <button type="button" id="remove_selected" class="button" style="padding: 8px 16px;">←</button>
                    <button type="button" id="add_all" class="button" style="padding: 8px 16px;">全部→</button>
                    <button type="button" id="remove_all" class="button" style="padding: 8px 16px;">全部←</button>
                </div>
                
                <!-- 右侧：已选歌曲 -->
                <div class="song-selector-box">
                    <h3>已选歌曲</h3>
                    <div style="height: 34px; margin-bottom: 10px;"></div> <!-- 搜索框占位 -->
                    {{ form.selected_songs }}
                    <div class="selected-count" id="selected_count">共 0 首歌曲</div>
                    <div class="button-group">
                        <button type="button" id="clear_all">清空</button>
                        <button type="button" id="remove_filtered">移除搜索结果</button>
                    </div>
                </div>
            </div>
            
            <!-- 标签选择 -->
            <div class="tag-selector">
                <label for="{{ form.tag.id_for_label }}">{{ form.tag.label }}:</label>
                {{ form.tag }}
                <span style="margin-left: 10px; color: #666; font-size: 12px;">请选择要添加的标签</span>
            </div>
            
            <div class="submit-row">
                <input type="submit" value="批量添加" class="default" name="_save">
                <a href="{% url 'admin:main_songtag_changelist' %}" class="button">返回列表</a>
            </div>
        </div>
    </form>
</div>

<style>
.form-row {
    padding: 10px;
    border-bottom: 1px solid #eee;
}
.form-row:last-child {
    border-bottom: none;
}
.field-box {
    display: inline-block;
    vertical-align: top;
}
.help {
    margin-top: 5px;
    font-size: 12px;
    color: #666;
}
.selector {
    width: 800px;
}
.selector select {
    width: 380px;
}
.selector-available, .selector-chosen {
    width: 380px;
}

/* 搜索框样式 */
.search-container {
    background: #f8f8f8;
    padding: 15px;
    border: 1px solid #ddd;
    border-radius: 4px;
    margin-bottom: 20px;
}
.search-container label {
    display: inline-block;
    margin-right: 10px;
    font-weight: bold;
}

/* 已选项目展示框 */
.selected-items-box {
    background: #f9f9f9;
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 10px;
    min-height: 60px;
    max-height: 150px;
    overflow-y: auto;
    width: 400px;
}
.selected-items-box .item {
    display: inline-block;
    background: #79aec8;
    color: white;
    padding: 3px 8px;
    margin: 2px;
    border-radius: 3px;
    font-size: 12px;
}
.selected-items-box .count {
    color: #666;
    font-size: 12px;
    margin-top: 5px;
}
</style>
{% endblock %}