{% extends "admin/base_site.html" %}

{% block content %}
<div class="module" style="max-width: 800px; margin: 0 auto;">
    <h2>上传图片到 {{ gallery.title }}</h2>

    <div class="form-row">
        <div>
            <label>图集路径：</label>
            <code>{{ gallery.folder_path }}</code>
        </div>
        <div>
            <label>当前图片数量：</label>
            <strong>{{ gallery.image_count }}</strong>
        </div>
    </div>

    <form method="post" enctype="multipart/form-data" id="upload-form" style="margin-top: 20px;">
        {% csrf_token %}

        <div class="form-row">
            <div>
                <label for="image-input" style="display: block; margin-bottom: 5px; font-weight: bold;">
                    选择图片：
                </label>
                <input
                    type="file"
                    name="image"
                    accept="image/jpeg,image/jpg,image/png,image/webp,image/gif,video/mp4"
                    id="image-input"
                    style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"
                >
                <p style="font-size: 12px; color: #666; margin-top: 5px;">
                    支持 JPG、PNG、WEBP、GIF、MP4 格式，建议大小不超过 5MB（MP4 建议不超过 10 秒）
                </p>
            </div>
        </div>

        <div style="margin-top: 20px;">
            <button
                type="submit"
                class="button"
                style="padding: 10px 20px; background: #417690; color: white; border: none; border-radius: 4px; cursor: pointer;"
            >
                上传图片
            </button>
            <a
                href="{% url 'admin:gallery_gallery_change' gallery.id %}"
                style="margin-left: 10px; color: #666; text-decoration: none;"
            >
                返回
            </a>
        </div>
    </form>

    <div id="upload-progress" style="display: none; margin-top: 30px; padding: 20px; background: #f5f5f5; border-radius: 4px;">
        <p style="margin-bottom: 10px; font-weight: bold;">上传中...</p>
        <progress id="progress-bar" value="0" max="100" style="width: 100%;"></progress>
        <p id="progress-text" style="margin-top: 10px; font-size: 14px; color: #666;">0%</p>
    </div>

    <div id="upload-result" style="margin-top: 20px;"></div>
</div>

<script>
document.getElementById('upload-form').addEventListener('submit', function(e) {
    e.preventDefault();

    const formData = new FormData();
    const fileInput = document.getElementById('image-input');
    const file = fileInput.files[0];

    if (!file) {
        alert('请选择图片');
        return;
    }

    // 文件大小检查（5MB）
    if (file.size > 5 * 1024 * 1024) {
        alert('图片大小不能超过 5MB');
        return;
    }

    formData.append('image', file);

    const xhr = new XMLHttpRequest();
    xhr.open('POST', '', true);

    // 上传进度
    xhr.upload.onprogress = function(e) {
        if (e.lengthComputable) {
            const percent = Math.round((e.loaded / e.total) * 100);
            document.getElementById('progress-bar').value = percent;
            document.getElementById('progress-text').textContent = percent + '%';
        }
    };

    xhr.onload = function() {
        document.getElementById('upload-progress').style.display = 'none';

        if (xhr.status === 200) {
            const response = JSON.parse(xhr.responseText);
            if (response.success) {
                document.getElementById('upload-result').innerHTML =
                    '<div style="padding: 15px; background: #d4edda; border: 1px solid #c3e6cb; border-radius: 4px; color: #155724;">' +
                    '<strong>上传成功！</strong><br>' +
                    '文件名: ' + response.filename + '<br>' +
                    '当前图片数量: ' + response.image_count +
                    '</div>';

                // 2秒后返回详情页
                setTimeout(() => {
                    window.location.href = "{% url 'admin:gallery_gallery_change' gallery.id %}";
                }, 2000);
            } else {
                document.getElementById('upload-result').innerHTML =
                    '<div style="padding: 15px; background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 4px; color: #721c24;">' +
                    '<strong>上传失败！</strong><br>' +
                    response.message +
                    '</div>';
            }
        } else {
            document.getElementById('upload-result').innerHTML =
                '<div style="padding: 15px; background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 4px; color: #721c24;">' +
                '<strong>上传失败！</strong><br>' +
                '服务器错误，请稍后重试' +
                '</div>';
        }
    };

    xhr.onerror = function() {
        document.getElementById('upload-progress').style.display = 'none';
        document.getElementById('upload-result').innerHTML =
            '<div style="padding: 15px; background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 4px; color: #721c24;">' +
            '<strong>上传失败！</strong><br>' +
            '网络错误，请检查连接后重试' +
            '</div>';
    };

    document.getElementById('upload-progress').style.display = 'block';
    xhr.send(formData);
});
</script>
{% endblock %}