{% extends "admin/change_form.html" %}

{% block extrahead %}
{{ block.super }}
<style>
#images-section {
    background: #f9f9f9;
    padding: 20px;
    border-radius: 8px;
    margin-top: 20px;
}

.toolbar {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    flex-wrap: wrap;
}

.toolbar button {
    padding: 8px 16px;
    border: 1px solid #ddd;
    background: white;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
}

.toolbar button:hover {
    background: #f0f0f0;
}

.toolbar button.primary {
    background: #417690;
    color: white;
    border-color: #417690;
}

.toolbar button.primary:hover {
    background: #3a6a80;
}

.images-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 15px;
    max-height: 600px;
    overflow-y: auto;
    padding: 10px;
    background: white;
    border: 1px solid #ddd;
    border-radius: 4px;
}

.image-item {
    position: relative;
    aspect-ratio: 1;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    transition: transform 0.2s;
}

.image-item:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

.image-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.image-info {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: rgba(0,0,0,0.7);
    color: white;
    padding: 5px;
    font-size: 11px;
    text-align: center;
}

.delete-btn {
    position: absolute;
    top: 5px;
    right: 5px;
    width: 24px;
    height: 24px;
    background: rgba(220, 53, 69, 0.9);
    color: white;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    opacity: 0;
    transition: opacity 0.2s;
}

.image-item:hover .delete-btn {
    opacity: 1;
}

.delete-btn:hover {
    background: rgba(220, 53, 69, 1);
}

.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #999;
}

.cover-badge {
    position: absolute;
    top: 5px;
    left: 5px;
    background: rgba(255, 193, 7, 0.9);
    color: white;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 10px;
    font-weight: bold;
}
</style>
{% endblock %}

{% block after_field_sets %}
{{ block.super }}

<div id="images-section">
    <h3 style="margin-top: 0; margin-bottom: 15px;">ğŸ“¸ å›¾ç‰‡ç®¡ç†</h3>

    <div class="toolbar">
        <button type="button" class="primary" onclick="uploadImage()">
            â• ä¸Šä¼ å›¾ç‰‡
        </button>
        <button type="button" onclick="updateCover()">
            ğŸ–¼ï¸ æ›´æ–°å°é¢
        </button>
        <button type="button" onclick="refreshCount()">
            ğŸ”„ åˆ·æ–°æ•°é‡
        </button>
        <button type="button" onclick="refreshImages()">
            ğŸ“· åˆ·æ–°åˆ—è¡¨
        </button>
    </div>

    <div id="images-container">
        <div class="empty-state">åŠ è½½ä¸­...</div>
    </div>
</div>

<script>
const galleryId = '{{ original.id }}';
const galleryFolderPath = '{{ original.folder_path }}';

// é¡µé¢åŠ è½½æ—¶è·å–å›¾ç‰‡
document.addEventListener('DOMContentLoaded', function() {
    loadImages();
});

// åŠ è½½å›¾ç‰‡åˆ—è¡¨
function loadImages() {
    fetch(`/api/gallery/${galleryId}/images/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                renderImages(data.images);
            } else {
                document.getElementById('images-container').innerHTML =
                    '<div class="empty-state">åŠ è½½å¤±è´¥: ' + data.message + '</div>';
            }
        })
        .catch(error => {
            document.getElementById('images-container').innerHTML =
                '<div class="empty-state">åŠ è½½å¤±è´¥: ' + error.message + '</div>';
        });
}

// æ¸²æŸ“å›¾ç‰‡
function renderImages(images) {
    const container = document.getElementById('images-container');

    if (!images || images.length === 0) {
        container.innerHTML = '<div class="empty-state">æš‚æ— å›¾ç‰‡<br><small>ç‚¹å‡»"ä¸Šä¼ å›¾ç‰‡"æ·»åŠ </small></div>';
        return;
    }

    let html = '<div class="images-grid">';

    // å°é¢å›¾ç‰‡
    if (images.cover) {
        html += `
            <div class="image-item">
                <img src="${images.cover.url}" alt="å°é¢">
                <div class="cover-badge">å°é¢</div>
                <div class="image-info">cover.jpg</div>
            </div>
        `;
    }

    // å…¶ä»–å›¾ç‰‡
    images.others.forEach(img => {
        html += `
            <div class="image-item">
                <img src="${img.url}" alt="${img.filename}">
                <button class="delete-btn" onclick="deleteImage('${img.filename}')" title="åˆ é™¤å›¾ç‰‡">Ã—</button>
                <div class="image-info">${img.filename}</div>
            </div>
        `;
    });

    html += '</div>';
    container.innerHTML = html;
}

// ä¸Šä¼ å›¾ç‰‡
function uploadImage() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/jpeg,image/jpg,image/png,image/webp,image/gif,video/mp4';

    input.onchange = function() {
        if (input.files.length === 0) return;

        const file = input.files[0];

        // æ–‡ä»¶å¤§å°æ£€æŸ¥
        if (file.size > 5 * 1024 * 1024) {
            alert('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡ 5MB');
            return;
        }

        const formData = new FormData();
        formData.append('image', file);

        fetch(`/admin/gallery/gallery/${galleryId}/upload-image/`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('ä¸Šä¼ æˆåŠŸï¼');
                loadImages();
                // åˆ·æ–°é¡µé¢ä»¥æ›´æ–°å›¾ç‰‡æ•°é‡
                setTimeout(() => location.reload(), 500);
            } else {
                alert('ä¸Šä¼ å¤±è´¥: ' + data.message);
            }
        })
        .catch(error => {
            alert('ä¸Šä¼ å¤±è´¥: ' + error.message);
        });
    };

    input.click();
}

// åˆ é™¤å›¾ç‰‡
function deleteImage(filename) {
    if (!confirm(`ç¡®å®šè¦åˆ é™¤å›¾ç‰‡ "${filename}" å—ï¼Ÿ`)) {
        return;
    }

    fetch(`/admin/gallery/gallery/${galleryId}/delete-image/${filename}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('åˆ é™¤æˆåŠŸï¼');
            loadImages();
            // åˆ·æ–°é¡µé¢ä»¥æ›´æ–°å›¾ç‰‡æ•°é‡
            setTimeout(() => location.reload(), 500);
        } else {
            alert('åˆ é™¤å¤±è´¥: ' + data.message);
        }
    })
    .catch(error => {
        alert('åˆ é™¤å¤±è´¥: ' + error.message);
    });
}

// æ›´æ–°å°é¢
function updateCover() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/jpeg,image/jpg,image/png,image/webp,image/gif,video/mp4';

    input.onchange = function() {
        if (input.files.length === 0) return;

        const file = input.files[0];

        // æ–‡ä»¶å¤§å°æ£€æŸ¥
        if (file.size > 5 * 1024 * 1024) {
            alert('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡ 5MB');
            return;
        }

        if (!confirm(`ç¡®å®šè¦å°† "${file.name}" è®¾ç½®ä¸ºå°é¢å—ï¼Ÿ`)) {
            return;
        }

        const formData = new FormData();
        formData.append('cover', file);

        fetch(`/admin/gallery/gallery/${galleryId}/update-cover/`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('å°é¢æ›´æ–°æˆåŠŸï¼');
                loadImages();
            } else {
                alert('æ›´æ–°å¤±è´¥: ' + data.message);
            }
        })
        .catch(error => {
            alert('æ›´æ–°å¤±è´¥: ' + error.message);
        });
    };

    input.click();
}

// åˆ·æ–°å›¾ç‰‡æ•°é‡
function refreshCount() {
    fetch(`/admin/gallery/gallery/${galleryId}/refresh-count/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('å›¾ç‰‡æ•°é‡å·²åˆ·æ–°: ' + data.image_count);
            setTimeout(() => location.reload(), 500);
        } else {
            alert('åˆ·æ–°å¤±è´¥');
        }
    })
    .catch(error => {
        alert('åˆ·æ–°å¤±è´¥: ' + error.message);
    });
}

// åˆ·æ–°å›¾ç‰‡åˆ—è¡¨
function refreshImages() {
    loadImages();
}

// è·å– CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}